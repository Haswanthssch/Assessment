{% extends "base_admin.html" %}
{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block content %}
<!-- Stats Cards -->
<div class="row g-4 mb-4" id="statsRow">
    <div class="col-sm-6 col-xl-3">
        <div class="stat-card card border-0 shadow-sm">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="stat-icon bg-primary-subtle text-primary"><i class="bi bi-people-fill fs-4"></i></div>
                <div>
                    <div class="stat-value" id="statUsers">–</div>
                    <div class="stat-label">Total Users</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-xl-3">
        <div class="stat-card card border-0 shadow-sm">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="stat-icon bg-success-subtle text-success"><i class="bi bi-box-fill fs-4"></i></div>
                <div>
                    <div class="stat-value" id="statProducts">–</div>
                    <div class="stat-label">Products</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-xl-3">
        <div class="stat-card card border-0 shadow-sm">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="stat-icon bg-warning-subtle text-warning"><i class="bi bi-cart-check-fill fs-4"></i></div>
                <div>
                    <div class="stat-value" id="statOrders">–</div>
                    <div class="stat-label">Orders</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-xl-3">
        <div class="stat-card card border-0 shadow-sm">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="stat-icon bg-danger-subtle text-danger"><i class="bi bi-currency-dollar fs-4"></i></div>
                <div>
                    <div class="stat-value" id="statRevenue">–</div>
                    <div class="stat-label">Revenue</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Orders by Status -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-0 fw-semibold pt-4 px-4">
                <i class="bi bi-bar-chart-fill me-2 text-primary"></i>Orders by Status
            </div>
            <div class="card-body px-4" id="statusChart">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
        </div>
    </div>
    <!-- Low Stock Alerts -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-0 fw-semibold pt-4 px-4">
                <i class="bi bi-exclamation-triangle-fill me-2 text-warning"></i>Low Stock Alerts
            </div>
            <div class="card-body px-4">
                <div id="lowStockValue" class="display-4 fw-bold text-warning">–</div>
                <p class="text-muted">Products below reorder level</p>
                <a href="/admin/inventory" class="btn btn-warning btn-sm">View Inventory</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    const token = localStorage.getItem('adminToken');

    async function loadStats() {
        const res = await fetch('/api/v1/admin/stats', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) { window.location.href = '/admin/login'; return; }
        const d = await res.json();

        document.getElementById('statUsers').textContent = d.total_users;
        document.getElementById('statProducts').textContent = d.total_products;
        document.getElementById('statOrders').textContent = d.total_orders;
        document.getElementById('statRevenue').textContent = '$' + d.total_revenue.toLocaleString('en-US', { minimumFractionDigits: 2 });
        document.getElementById('lowStockValue').textContent = d.low_stock_alerts;

        // Status breakdown
        const statusDiv = document.getElementById('statusChart');
        const colors = { pending: 'warning', confirmed: 'info', shipped: 'primary', delivered: 'success', cancelled: 'danger' };
        statusDiv.innerHTML = Object.entries(d.orders_by_status).map(([s, c]) => `
    <div class="d-flex align-items-center justify-content-between mb-3">
      <span class="badge bg-${colors[s] || 'secondary'} text-capitalize px-3 py-2">${s}</span>
      <div class="flex-grow-1 mx-3">
        <div class="progress" style="height:8px">
          <div class="progress-bar bg-${colors[s] || 'secondary'}" style="width:${Math.min(c / d.total_orders * 100, 100)}%"></div>
        </div>
      </div>
      <span class="fw-semibold">${c}</span>
    </div>`).join('') || '<p class="text-muted">No orders yet.</p>';
    }
    loadStats();
</script>
{% endblock %}