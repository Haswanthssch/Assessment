{% extends "base_user.html" %}
{% block title %}Browse Products{% endblock %}
{% block content %}
<div class="container py-5">
    <!-- Hero Banner -->
    <div class="products-hero rounded-4 p-5 mb-5 text-white text-center">
        <h1 class="fw-bold display-5">Shop Everything</h1>
        <p class="lead opacity-75">Electronics, Furniture, Stationery & more</p>
        <div class="input-group mx-auto search-bar mt-3">
            <input type="text" class="form-control form-control-lg border-0 shadow-none" id="searchInput"
                placeholder="Search products…" oninput="filterProducts()" />
            <span class="input-group-text border-0"><i class="bi bi-search"></i></span>
        </div>
    </div>

    <!-- Category Filters -->
    <div class="d-flex flex-wrap gap-2 mb-4" id="categoryFilters">
        <button class="btn btn-primary btn-sm px-4 rounded-pill active-cat" onclick="setCategory('')"
            data-cat="">All</button>
        <button class="btn btn-outline-primary btn-sm px-4 rounded-pill" onclick="setCategory('Electronics')"
            data-cat="Electronics">Electronics</button>
        <button class="btn btn-outline-primary btn-sm px-4 rounded-pill" onclick="setCategory('Furniture')"
            data-cat="Furniture">Furniture</button>
        <button class="btn btn-outline-primary btn-sm px-4 rounded-pill" onclick="setCategory('Stationery')"
            data-cat="Stationery">Stationery</button>
    </div>

    <!-- Product Grid -->
    <div class="row g-4" id="productsGrid">
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary"></div>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:9999">
    <div id="cartToast" class="toast align-items-center text-bg-success border-0 shadow" role="alert"
        data-bs-autohide="true" data-bs-delay="2000">
        <div class="d-flex">
            <div class="toast-body fw-semibold"><i class="bi bi-cart-check me-2"></i>Added to cart!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    let allProducts = [];
    let activeCategory = '';

    async function loadProducts() {
        const res = await fetch('/api/v1/products/?limit=100');
        allProducts = await res.json();
        renderProducts(allProducts);
    }

    function setCategory(cat) {
        activeCategory = cat;
        document.querySelectorAll('[data-cat]').forEach(btn => {
            btn.classList.toggle('active-cat', btn.dataset.cat === cat);
            btn.classList.toggle('btn-primary', btn.dataset.cat === cat);
            btn.classList.toggle('btn-outline-primary', btn.dataset.cat !== cat);
        });
        filterProducts();
    }

    function filterProducts() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allProducts.filter(p =>
            (!activeCategory || p.category === activeCategory) &&
            (p.name.toLowerCase().includes(q) || (p.description || '').toLowerCase().includes(q))
        );
        renderProducts(filtered);
    }

    function renderProducts(products) {
        const grid = document.getElementById('productsGrid');
        if (!products.length) {
            grid.innerHTML = '<div class="col-12 text-center py-5 text-muted"><i class="bi bi-search display-4 d-block mb-3"></i>No products found.</div>';
            return;
        }
        grid.innerHTML = products.map(p => `
    <div class="col-sm-6 col-lg-4 col-xl-3">
      <div class="product-card card border-0 shadow-sm h-100">
        <div class="product-img-wrap overflow-hidden">
          <img src="${p.image_url || 'https://placehold.co/300x200/eee/aaa?text=Product'}"
               class="card-img-top product-img" alt="${p.name.replace(/"/g, '&quot;')}" />
          <div class="product-category-badge">${p.category || ''}</div>
        </div>
        <div class="card-body d-flex flex-column">
          <h6 class="fw-bold mb-1">${p.name.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</h6>
          <p class="text-muted small flex-grow-1 text-truncate-2">${(p.description || '').replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>
          <div class="d-flex align-items-center justify-content-between mt-2">
            <span class="fs-5 fw-bold text-primary">₹${p.price.toFixed(2)}</span>
            <button class="btn btn-primary btn-sm px-3" onclick="addToCart(${p.id})">
              <i class="bi bi-cart-plus me-1"></i>Add
            </button>
          </div>
        </div>
      </div>
    </div>`).join('');
    }

    function addToCart(id) {
        const product = allProducts.find(p => p.id === id);
        if (!product) return;
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const existing = cart.find(i => i.id === id);
        if (existing) existing.quantity++;
        else cart.push({ id: product.id, name: product.name, price: product.price, quantity: 1 });
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartCount();
        new bootstrap.Toast(document.getElementById('cartToast')).show();
    }

    function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const el = document.getElementById('cartCount');
        if (el) el.textContent = cart.reduce((s, i) => s + i.quantity, 0);
    }

    loadProducts();
</script>
{% endblock %}